# 用户认证接口文档

本文档描述了系统的用户认证相关接口，供前端开发参考。

## 接口概览

| 接口名称 | 请求路径 | 请求方法 | 是否需要认证 | 功能描述 |
|---------|---------|----------|-------------|----------|
| 获取验证码 | `/auth/captcha` | GET | 否 | 向指定手机号发送短信验证码 |
| 用户登录 | `/auth/login` | POST | 否 | 手机号+验证码登录 |
| 刷新令牌 | `/auth/refresh` | POST | 否 | 使用refresh_token换取新的访问令牌 |
| 用户注销 | `/auth/logout` | POST | 是 | 让当前access_token失效 |
| 验证令牌 | `/auth/verify` | POST | 是 | 检查当前access_token是否仍然有效 |
| 获取用户权限 | `/me/permissions` | GET | 是 | 返回当前登录用户的权限、租户与部门范围 |

## 详细接口说明

### 1. 获取验证码

**接口路径：** `/auth/captcha`

**请求方法：** GET

**请求参数：**
```
Query参数：
- phone: string (必填) - 手机号
- type: string (可选) - 验证码类型
```

**请求示例：**
```
GET /auth/captcha?phone=13800138000&type=login
```

**响应参数：**
```json
{
  // 空响应对象
}
```

**响应说明：**
- 成功发送验证码后返回空对象
- 失败时返回相应的错误信息

---

### 2. 用户登录

**接口路径：** `/auth/login`

**请求方法：** POST

**Content-Type：** application/json

**请求参数：**
```json
{
  "phone": "string",      // 必填，手机号
  "captcha": "string",    // 必填，短信验证码
  "login_type": "string"  // 必填，登录类型
}
```

**请求示例：**
```json
{
  "phone": "13800138000",
  "captcha": "123456",
  "login_type": "sms"
}
```

**响应参数：**
```json
{
  "token": "string",           // 访问令牌
  "refresh_token": "string",   // 刷新令牌
  "expires_in": 7200,          // 令牌过期时间（秒）
  "user": {
    "user_id": "string",       // 用户ID
    "user_name": "string",     // 用户名
    "phone": "string",         // 手机号
    "roles": [                 // 用户角色列表
      {
        "role_id": "string",   // 角色ID
        "name": "string",      // 角色名称
        "modules": ["string"]  // 角色拥有的模块权限
      }
    ],
    "modules": ["string"]      // 用户拥有的模块权限
  }
}
```

**响应示例：**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 7200,
  "user": {
    "user_id": "123456",
    "user_name": "张三",
    "phone": "13800138000",
    "roles": [
      {
        "role_id": "admin",
        "name": "管理员",
        "modules": ["user", "system", "report"]
      }
    ],
    "modules": ["user", "system", "report"]
  }
}
```

---

### 3. 刷新令牌

**接口路径：** `/auth/refresh`

**请求方法：** POST

**Content-Type：** application/json

**请求参数：**
```json
{
  "refresh_token": "string"  // 必填，刷新令牌
}
```

**请求示例：**
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**响应参数：**
```json
{
  "token": "string",           // 新的访问令牌
  "refresh_token": "string",   // 新的刷新令牌
  "expires_in": 7200           // 令牌过期时间（秒）
}
```

**响应示例：**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 7200
}
```

---

### 4. 用户注销

**接口路径：** `/auth/logout`

**请求方法：** POST

**认证要求：** 需要Bearer Token

**请求头：**
```
Authorization: Bearer <access_token>
```

**请求参数：** 无

**响应参数：**
```json
{
  "message": "string"  // 注销成功消息
}
```

---

### 5. 验证令牌

**接口路径：** `/auth/verify`

**请求方法：** POST

**认证要求：** 需要Bearer Token

**请求头：**
```
Authorization: Bearer <access_token>
```

**请求参数：** 无

**响应参数：**
```json
{
  "valid": true,                    // 令牌是否有效
  "user_id": "string",             // 用户ID
  "expires_at": "2024-01-01T00:00:00Z",  // 过期时间
  "issued_at": "2023-12-31T00:00:00Z",   // 签发时间
  "token_id": "string",            // 令牌ID
  "user_type": "string",           // 用户类型
  "modules": ["string"],           // 用户模块权限
  "phone": "string",               // 手机号
  "tenant_id": "string",           // 租户ID（可选）
  "tenant_type": "string",         // 租户类型（可选）
  "tenant_name": "string"          // 租户名称（可选）
}
```

---

### 6. 获取用户权限

**接口路径：** `/me/permissions`

**请求方法：** GET

**认证要求：** 需要Bearer Token

**请求头：**
```
Authorization: Bearer <access_token>
```

**请求参数：** 无

**响应参数：**
```json
{
  "user": {
    "id": "string",        // 用户ID
    "name": "string",      // 用户名称
    "phone": "string",     // 手机号
    "role": "string",      // 角色ID
    "role_name": "string"  // 角色名称
  },
  "current_tenant": {      // 当前租户信息（可选）
    "tenant_type": "string",
    "tenant_id": "string",
    "tenant_name": "string",
    "parent_tenant": {},   // 父租户信息
    "role": "string",
    "is_default": true
  },
  "available_tenants": [   // 可用租户列表
    {
      "tenant_type": "string",
      "tenant_id": "string",
      "tenant_name": "string",
      "parent_tenant": {},
      "role": "string",
      "is_default": true
    }
  ],
  "department_scope": {    // 部门权限范围
    "type": "string",
    "department_ids": ["string"]
  },
  "available_modules": ["string"],  // 可用模块列表
  "permission_tree": {}    // 权限树结构
}
```

## 认证流程说明

### 登录流程
1. 前端调用 `/auth/captcha` 获取短信验证码
2. 用户输入验证码后，调用 `/auth/login` 进行登录
3. 登录成功后保存返回的 `token` 和 `refresh_token`
4. 在后续请求的 Header 中添加 `Authorization: Bearer <token>`

### 令牌刷新流程
1. 当接口返回 401 或令牌即将过期时
2. 调用 `/auth/refresh` 使用 `refresh_token` 获取新的令牌
3. 更新本地存储的 `token` 和 `refresh_token`
4. 使用新的 `token` 继续请求

### 错误处理
- 401 Unauthorized：令牌无效或已过期，需要重新登录或刷新令牌
- 403 Forbidden：权限不足，无法访问该资源
- 400 Bad Request：请求参数错误
- 500 Internal Server Error：服务器内部错误

## 注意事项
1. 所有时间戳单位均为秒
2. 令牌有效期默认为2小时（7200秒）
3. 刷新令牌有效期较长，但也要定期刷新
4. 敏感接口都需要在请求头中携带有效的访问令牌